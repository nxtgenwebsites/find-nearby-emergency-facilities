<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Health Centre App</title>

    <!-- Existing styles and libs -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/nearby-services.css" />
    <link rel="stylesheet" href="css/responsive.css" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <style>
        /* Ensure map has height */
        #map {
            min-height: 380px;
            height: 100%;
        }

        .leaflet-container {
            border-radius: 8px;
        }

        .map-details-popup h6 {
            margin: 0;
        }

        .leaflet-div-icon {
            background: transparent;
            border: none;
        }
    </style>
</head>

<body>
    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>
    <div class="overlay" id="overlay2"></div>

    <!-- Profile Coming Soon Modal -->
    <div class="location-modal" id="profileModal">
        <h3>Coming Soon!</h3>
        <p>User profile feature isn't available yet!</p>
        <div class="location-buttons">
            <button class="btn-location btn-allow" id="closeProfileBtn">Go back</button>
        </div>
    </div>

    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-img">
                        <img src="assets/images/logo.svg" alt="">
                    </div>
                </a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link active">
                        <img src="assets/icons/home.svg" />
                        <span>Home</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="about-us.html" class="nav-link">
                        <img src="assets/icons/info.svg" />
                        <span>About Us</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="contact-us.html" class="nav-link">
                        <img src="assets/icons/mail.svg" />
                        <span>Contact Us</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="editions.html" class="nav-link">
                        <img src="assets/icons/book.svg" />
                        <span>Editions</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="commingSoon('Reviews Page')">
                        <img src="assets/icons/star.svg" />
                        <span>Reviews</span>
                    </a>
                </li>
                <li class="nav-item no-page">
                    <a href="partnerships.html" class="nav-link">
                        <img src="assets/icons/ph_handshake.svg" />
                        <span>Partnerships</span>
                    </a>
                </li>
                <li class="nav-item no-page">
                    <a href="#" class="nav-link" onclick="commingSoon('System Page')">
                        <img src="assets/icons/settings.svg" />
                        <span>System</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <main class="main-content w-100">
            <!-- Header -->
            <header class="header d-lg-none">
                <a href="index.html" class="mobile-logo">
                    <img src="assets/images/logo.svg">
                </a>
                <div class="header-right">
                    <div class="user profile-button">
                        <img src="assets/icons/user-icon.svg" alt="">
                    </div>
                    <button class="menu-toggle" id="menuToggle">
                        <img src="assets/icons/bars.svg" alt="">
                    </button>
                </div>
            </header>

            <!-- Header Section -->
            <div class="header-section">
                <div class="d-none d-lg-flex flex-column-reverse mb-4">
                    <div class="d-none d-lg-block">
                        <h6 class="mb-1 result-text">
                            We <span class="fw-bold text-black">found <span id="resultCount">0</span> nearby</span>
                            Medical Services to your current location
                        </h6>
                    </div>
                    <div class="dropdown pb-2">
                        <button class="profile-btn d-none d-lg-flex align-items-center profile-button">
                            <img src="assets/icons/user-icon.svg" width="30" alt="">
                            <i class="dropdown-toggle"></i>
                        </button>
                    </div>
                </div>

                <div class="row row-gap-3 flex-column-reverse flex-md-row">
                    <div class="col-12 col-md-4 d-none">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control search-input" id="hospitalSearch"
                                placeholder="Search hospitals..." class="form-control" />
                        </div>
                    </div>
                    <div class="col-12 d-lg-none">
                        <div>
                            <h6 class="mb-1 result-text">
                                We <span class="fw-bold text-black">found <span id="resultCount2">0</span> nearby</span>
                                Medical Services to your current location
                            </h6>
                        </div>
                    </div>
                    <div class="col-12">
                        <!-- Location Info -->
                        <div class="location-info">
                            <div
                                class="d-flex flex-column row-gap-3 flex-md-row justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="assets/icons/select-location.svg" alt="Location Icon" class="me-2"
                                        style="width: 30px; height: 30px;">
                                    <span id="user-location">Getting your location...</span>
                                </div>
                                <button class="btn change-location" id="searchSection">Change Location</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Results Section -->
                <div class="results-section">
                    <!-- Error message -->
                    <div id="error" class="error" style="display: none;">
                        <h5>Unable to load hospitals</h5>
                        <p>Please check your location settings and try again.</p>
                    </div>

                    <!-- Loading indicator -->
                    <div id="loading" class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Finding nearby hospitals...</p>
                    </div>

                    <div id="healthCenters"></div>

                    <!-- Pagination -->
                    <nav aria-label="Health centers pagination">
                        <div id="pagination"></div>
                    </nav>
                </div>

                <!-- Map Section -->
                <div class="map-section">
                    <div class="map-container">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Search popup modal -->
    <div class="popup-overlay d-none" id="seach-popup">
        <div class="seacrch-card">
            <div class="p-3 position-relative">
                <h5 class="modal-title text-center">Change location</h5>
                <button type="button" class="btn-close position-absolute top-0" style="right: -10px;"></button>
            </div>
            <form id="searchForm">
                <div class="row mt-3">
                    <div class="col-md-6 mb-3">
                        <label for="country" class="form-label">Country</label>
                        <select class="form-select" id="user-country" name="country">
                            <option value="">Select</option>
                            <option value="nigeria">Nigeria</option>
                            <option value="pakistan">Pakistan</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="state" class="form-label">State</label>
                        <select class="form-select" id="user-state" name="state">
                            <option value="">Select</option>
                            <option value="enugu">Enugu</option>
                            <option value="punjab">Punjab</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3 city-inp">
                        <label for="city" class="form-label">City/Region/Local Govt</label>
                        <input type="text" class="form-control" id="city" name="city" placeholder="Type here" />
                    </div>
                    <div class="col-12 mb-3 services-type d-none">
                        <label for="services-type" class="form-label">Facility Type</label>
                        <select class="form-select" id="services-type" name="state">
                            <option value="" disabled selected>Select a facility type</option>
                            <option value="hospitals">Hospitals</option>
                            <option value="doctor">Doctor</option>
                            <option value="health">Health Center</option>
                            <option value="pharmacy">Pharmacy</option>
                            <option value="drugstore">Drugstore</option>
                            <option value="store">Medical Store</option>
                        </select>
                    </div>
                </div>
                <div class="text-center">
                    <button class="btn">Search</button>
                </div>
            </form>
        </div>
    </div>

    Report Location Modal
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content p-3">
                <div class="modal-header">
                    <div class="text">
                        <h5 class="modal-title" id="reportModalLabel">Report this location</h5>
                        <p class="text-muted mb-4">Please provide information below</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <form id="reportForm" action="https://formspree.io/f/xnngnyoo" method="POST">
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject/Headline</label>
                            <input type="text" class="form-control" id="subject" name="subject"
                                placeholder="Max 25 characters" maxlength="25" required>
                        </div>

                        <div class="mb-3">
                            <label for="details" class="form-label">Details</label>
                            <textarea class="form-control" id="details" name="details" rows="4"
                                placeholder="Max 250 characters" maxlength="250" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="actionRequired" class="form-label">Action required</label>
                            <select class="form-select" id="actionRequired" name="actionRequired" required>
                                <option value="">Select</option>
                                <option value="Correction">Correction</option>
                                <option value="Remove">Remove</option>
                                <option value="Investigate">Investigate</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="userRole" class="form-label">Your role</label>
                            <select class="form-select" id="userRole" name="userRole" required>
                                <option value="">Select</option>
                                <option value="User">User</option>
                                <option value="Owner">Owner</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        Google reCAPTCHA (unchanged UI)
                        <div class="mb-3">
                            <div class="g-recaptcha d-inline-block"
                                data-sitekey="6LfeldcrAAAAAHlG58vLNYwWApP2N1KEsHWbpH3m"></div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary px-4">Submit</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- Success popup (unchanged UI) -->
    <div class="formspree-popup" id="formspreePopup">
        <div class="formspree-popup-content">
            <h3>Submitted Thank You</h3>
            <p>We will get back to you as soon as possible!</p>
            <button class="formspree-popup-close" onclick="closeFormspreePopup()">Done</button>
        </div>
    </div>

    <!-- Send Details Modal (unchanged UI) -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 class="text-center">Send your details</h4>
                    <p class="text-center text-success mb-3">Thank you for your report, it is receiving attention</p>
                    <p class="text-muted mb-4">Please provide your details below in case we need to check some details
                        with you.</p>

                    <form id="detailsForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="title" class="form-label">Title</label>
                                <select class="form-select" id="title" name="title" required>
                                    <option value="">Select</option>
                                    <option value="Mr">Mr</option>
                                    <option value="Mrs">Mrs</option>
                                    <option value="Miss">Miss</option>
                                    <option value="Ms">Ms</option>
                                    <option value="Prof">Prof</option>
                                    <option value="Rev">Rev</option>
                                    <option value="Alhj">Alhj</option>
                                    <option value="Mlm">Mlm</option>
                                    <option value="Hon">Hon</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName" name="firstName"
                                    placeholder="John" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName" name="lastName" placeholder="Doe"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="country" class="form-label">Country</label>
                                <select class="form-select" id="user-country-2" name="country" required>
                                    <option value="">Select</option>
                                    <option value="Nigeria">Nigeria</option>
                                    <option value="South Africa">South Africa</option>
                                    <option value="UK">UK</option>
                                    <option value="America">America</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email"
                                    placeholder="abc@gmail.com" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="confirmEmail" class="form-label">Confirm Email</label>
                                <input type="email" class="form-control" id="confirmEmail" name="confirmEmail"
                                    placeholder="abc@gmail.com" required>
                            </div>
                        </div>

                        Google reCAPTCHA (unchanged UI)
                        <div class="text-center mb-3">
                            <div class="g-recaptcha d-inline-block"
                                data-sitekey="6LfeldcrAAAAAHlG58vLNYwWApP2N1KEsHWbpH3m"></div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn details-send-btn px-4">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/country-states.js"></script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
        // Formspree popup
        function closeFormspreePopup() {
            document.getElementById('formspreePopup').classList.remove('show');
        }

        // Country + State lists (unchanged UI behavior)
        var user_country_code = "";
        (() => {
            const country_list = country_and_states.country;
            const state_list = country_and_states.states;

            const id_state_option = document.getElementById("user-state");
            const id_country_option = document.getElementById("user-country");

            id_state_option.innerHTML = '<option>select state</option>';
            id_state_option.setAttribute("disabled", "disabled");

            const create_country_selection = () => {
                let option = '<option value="" selected disabled>Select Country</option>';
                for (const country_code in country_list) {
                    option += '<option value="' + country_code + '">' + country_list[country_code] + '</option>';
                }
                id_country_option.innerHTML = option;
            };

            const create_states_selection = () => {
                let selected_country_code = id_country_option.value;
                let state_names = state_list[selected_country_code];

                if (!state_names) {
                    id_state_option.innerHTML = '<option>select state</option>';
                    id_state_option.setAttribute("disabled", "disabled");
                    return;
                }

                let option = '<option>select state</option>';
                state_names.forEach(state => {
                    option += '<option value="' + state.code + '">' + state.name + '</option>';
                });

                id_state_option.innerHTML = option;
                id_state_option.removeAttribute("disabled");
            };

            id_country_option.addEventListener('change', create_states_selection);
            create_country_selection();
        })();

        (() => {
            const country_list = country_and_states.country;
            const id_country_option = document.getElementById("user-country-2");

            const create_country_selection = () => {
                let option = '<option value="" selected disabled>Select Country</option>';
                for (const country_code in country_list) {
                    let country_name = country_list[country_code];
                    option += '<option value="' + country_name + '">' + country_name + '</option>';
                }
                id_country_option.innerHTML = option;
            };

            create_country_selection();
        })();

        // Details form submit -> Formspree
        document.getElementById("detailsForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const form = e.target;
            const email = document.getElementById("email").value.trim();
            const confirmEmail = document.getElementById("confirmEmail").value.trim();
            if (email !== confirmEmail) {
                alert("❌ Email and confirm email do not match!");
                return;
            }
            const data = new FormData(form);

            try {
                const response = await fetch("https://formspree.io/f/mwprpjrq", {
                    method: "POST",
                    body: data,
                    headers: { "Accept": "application/json" }
                });

                if (response.ok) {
                    form.reset();
                    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('detailsModal'));
                    detailsModal.hide();

                    document.getElementById('reportForm').reset();
                    document.getElementById('detailsForm').reset();

                    document.getElementById('formspreePopup').classList.add('show');
                } else {
                    alert("❌ Oops! Something went wrong. Please try again.");
                }
            } catch {
                alert("⚠️ Network error. Please check your connection.");
            }
        });

        const form = document.getElementById("reportForm");
        const detailsForm = document.getElementById("detailsForm");

        form.addEventListener("submit", async function (e) {
            e.preventDefault();
            detailsForm.style.display = "block";

            try {
                const res = await fetch(form.action, {
                    method: "POST",
                    body: new FormData(form),
                    headers: { 'Accept': 'application/json' }
                });

                if (res.ok) {
                    detailsForm.classList.add("d-block");
                    form.reset();
                } else {
                    alert("Error! Please try again ❌");
                }
            } catch {
                alert("Something went wrong!");
            }
        });

        function openReportModal(locationName) {
            currentLocation = locationName;
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            modal.show();
        }

        document.getElementById('reportForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const subject = document.getElementById('subject').value;
            const details = document.getElementById('details').value;
            const actionRequired = document.getElementById('actionRequired').value;
            const userRole = document.getElementById('userRole').value;

            if (!subject || !details || !actionRequired || !userRole) {
                alert('Please fill in all required fields');
                return;
            }

            const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
            reportModal.hide();

            setTimeout(() => {
                const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
                detailsModal.show();
            }, 300);
        });

        // Profile popover open/close
        const profileButton = document.querySelectorAll('.profile-button');
        const profileModal = document.getElementById('profileModal');
        const closeProfileBtn = document.getElementById('closeProfileBtn');

        if (profileButton && profileModal && closeProfileBtn) {
            profileButton.forEach(button => {
                button.addEventListener('click', function () {
                    location.href = 'profile.html';
                });
            });

            closeProfileBtn.addEventListener('click', function () {
                profileModal.classList.remove('show');
                const overlay2 = document.getElementById('overlay2');
                if (overlay2) overlay2.classList.remove('show');
            });
        }
    </script>

    <script>
        // Geoapify
        const GEOAPIFY_API_KEY = "a475cbbc91c74896aeeac6b34a227603";
        const SEARCH_RADIUS_METERS = 2000; // 35km

        // Map + data state
        let map;
        let userMarker;
        let userCircle; // added: keep a reference to the radius circle
        let hospitalMarkers = [];
        let userLocation = null;

        let allHospitals = [];
        let filteredHospitals = [];
        let currentPage = 1;
        let itemsPerPage = 5;

        function stripLeadingName(text, name) {
            if (!text || !name) return text;
            const t = String(text).trim();
            const n = String(name).trim();
            if (t.toLowerCase().startsWith(n.toLowerCase())) {
                return t.slice(n.length).replace(/^,?\s*/, "");
            }
            return text;
        }

        function buildAddress(p = {}) {
            const parts = [];
            const line1 = [p.housenumber, p.street].filter(Boolean).join(' ').trim();
            if (line1) parts.push(line1);
            if (p.district) parts.push(p.district);
            if (p.city || p.town || p.village) parts.push(p.city || p.town || p.village);
            if (p.state) parts.push(p.state);
            if (p.postcode) parts.push(p.postcode);
            if (p.country) parts.push(p.country);

            let candidate = parts.filter(Boolean).join(', ');

            // Fallbacks: prefer address_line1/2 or formatted, but remove name if it prefixes them
            if (!candidate) {
                const options = [p.address_line1, p.address_line2, p.formatted].filter(Boolean);
                candidate = options.find(Boolean) || '';
            }

            if (p.name) {
                candidate = stripLeadingName(candidate, p.name);
            }
            return candidate || 'Address not available';
        }

        function getPhone(p = {}) {
            const raw = (p.datasource && p.datasource.raw) ? p.datasource.raw : {};
            const candidates = [
                p.phone,
                p.contact && p.contact.phone,
                raw.phone,
                raw['contact:phone'],
                raw['phone:mobile'],
                raw['phone:fixed_line'],
                raw['contact_mobile'],
                raw['contact_phone'],
            ];
            let phone = candidates.find(v => v);
            if (Array.isArray(phone)) phone = phone[0];
            if (phone && typeof phone === 'object') {
                const first = Object.values(phone).find(Boolean);
                if (first) phone = first;
            }
            return phone || 'Phone not available';
        }

        function initMap(lat, lon) {
            const center = [lat, lon];
            map = L.map('map').setView(center, 13);

            // Tile layer via Geoapify OSM tiles
            L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-carto/{z}/{x}/{y}.png?apiKey=${GEOAPIFY_API_KEY}`, {
                attribution: '&copy; <a href="https://www.geoapify.com/">Geoapify</a> contributors'
            }).addTo(map);

            userMarker = L.marker(center).addTo(map).bindPopup('<b>You are here</b>').openPopup();

            // Update or create the radius circle
            if (userCircle) {
                map.removeLayer(userCircle);
            }
            userCircle = L.circle(center, {
                color: "#d90429",
                fillColor: "#ef233c",
                fillOpacity: 0.2,
                radius: SEARCH_RADIUS_METERS
            }).addTo(map);
        }

        function getCurrentUserLocation() {
            if (!navigator.geolocation) {
                handleLocationError('Geolocation not supported');
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                userLocation = { lat, lon };

                // Set UI
                navigator.geolocation.getCurrentPosition(async position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`,
                            { headers: { 'User-Agent': 'location-app' } }
                        );
                        const data = await response.json();

                        const address = data.address;
                        let shortAddress = '';

                        if (address.city) shortAddress += address.city;
                        else if (address.town) shortAddress += address.town;
                        else if (address.village) shortAddress += address.village;

                        if (address.state) shortAddress += `, ${address.state}`;
                        if (address.country) shortAddress += `, ${address.country}`;

                        const userLocationEl = document.getElementById('user-location');
                        if (userLocationEl) {
                            userLocationEl.innerText = `Your Selected Location: ${shortAddress || data.display_name}`;
                        }
                    } catch (error) {
                        console.error(error);
                        const userLocationEl = document.getElementById('user-location');
                        if (userLocationEl) {
                            userLocationEl.innerText = 'Unable to fetch address.';
                        }
                    }
                }, () => {
                    const userLocationEl = document.getElementById('user-location');
                    if (userLocationEl) {
                        userLocationEl.innerText = 'Location access denied.';
                    }
                });


                // Init map and load hospitals
                initMap(lat, lon);
                await loadNearbyHospitals(lat, lon, "");
            }, () => {
                handleLocationError('Location access denied');
            }, {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 60000
            });
        }

        function handleLocationError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorEl = document.getElementById('error');
            errorEl.style.display = 'block';
            document.getElementById('healthCenters').innerHTML = '';
            errorEl.innerHTML = `
        <h5>Location Access Required</h5>
        <p>${message}. Please enable location services to find nearby hospitals.</p>
        <button class="btn btn-primary" onclick="getCurrentUserLocation()">Try Again</button>
      `;
        }

        async function geoapifyGeocode(text) {
            const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(text)}&format=json&apiKey=${GEOAPIFY_API_KEY}`;
            const res = await fetch(url);
            const data = await res.json();
            const first = data?.results?.[0];
            if (!first) return null;
            return { lat: first.lat, lon: first.lon, formatted: first.formatted };
        }

        async function loadNearbyHospitals(lat, lon, serviceType = "") {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';

                // Geoapify Places: hospitals in radius
                const url =
                    `https://api.geoapify.com/v2/places?categories=healthcare.hospital&filter=circle:${lon},${lat},${SEARCH_RADIUS_METERS}&bias=proximity:${lon},${lat}&limit=200&apiKey=${GEOAPIFY_API_KEY}`;

                const res = await fetch(url);
                const data = await res.json();

                const features = Array.isArray(data.features) ? data.features : [];

                // Map to unified hospital objects
                const mapped = features.map(f => {
                    const p = f.properties || {};
                    const hLat = p.lat;
                    const hLon = p.lon;

                    // Distance in miles
                    const distanceMiles = (userLocation)
                        ? haversineMiles(userLocation.lat, userLocation.lon, hLat, hLon)
                        : null;

                    return {
                        id: p.place_id || (p.datasource && p.datasource.raw && p.datasource.raw.osm_id) || `${hLat},${hLon}`,
                        name: p.name || "Unnamed Hospital",
                        lat: hLat,
                        lon: hLon,
                        address: buildAddress(p),            // fixed address
                        phone: getPhone(p),                  // better phone fallbacks
                        openingHours: p.opening_hours || "Hours not available",
                        distance: distanceMiles,
                        // types to support tag display
                        types: ["hospital"]
                    };
                });

                // Optional additional filter by serviceType (kept same UI logic)
                let finalList = mapped;
                if (serviceType && serviceType.trim()) {
                    const q = serviceType.toLowerCase();
                    finalList = finalList.filter(h =>
                        (h.name && h.name.toLowerCase().includes(q)) ||
                        (h.address && h.address.toLowerCase().includes(q)) ||
                        (Array.isArray(h.types) && h.types.some(t => t.toLowerCase().includes(q)))
                    );
                }

                // Sort by distance asc
                finalList.sort((a, b) => {
                    const da = a.distance ?? Infinity;
                    const db = b.distance ?? Infinity;
                    return da - db;
                });

                allHospitals = finalList;
                filteredHospitals = finalList;
                currentPage = 1;

                // Update counts/UI
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                const rc1 = document.getElementById('resultCount');
                const rc2 = document.getElementById('resultCount2');
                if (rc1) rc1.textContent = filteredHospitals.length;
                if (rc2) rc2.textContent = filteredHospitals.length;

                displayPaginatedHospitals();
                renderPagination();
                addHospitalMarkers(filteredHospitals.slice(0, itemsPerPage));
            } catch (err) {
                console.error(err);
                allHospitals = [];
                filteredHospitals = [];
                currentPage = 1;

                document.getElementById('loading').style.display = 'none';
                const errEl = document.getElementById('error');
                errEl.style.display = 'block';
                document.getElementById('healthCenters').innerHTML = '';
                const rc1 = document.getElementById('resultCount');
                const rc2 = document.getElementById('resultCount2');
                if (rc1) rc1.textContent = '0';
                if (rc2) rc2.textContent = '0';

                errEl.innerHTML = `
          <h5>Error Loading Health Services</h5>
          <p>Unable to load nearby facility services. Please try again later.</p>
          <button class="btn btn-primary" onclick="location.reload()">Retry</button>
        `;
                renderPagination();
            }
        }

        function filterHospitals(searchTerm) {
            if (!allHospitals.length) return;

            let filtered = allHospitals;
            if (searchTerm) {
                filtered = allHospitals.filter(h => {
                    const name = (h.name || '').toLowerCase();
                    const address = (h.address || '').toLowerCase();
                    const types = Array.isArray(h.types) ? h.types.some(t => t.toLowerCase().includes(searchTerm)) : false;
                    return name.includes(searchTerm) || address.includes(searchTerm) || types;
                });
            }

            filteredHospitals = filtered;
            currentPage = 1;

            const rc1 = document.getElementById('resultCount');
            const rc2 = document.getElementById('resultCount2');
            if (rc1) rc1.textContent = filteredHospitals.length;
            if (rc2) rc2.textContent = filteredHospitals.length;

            displayPaginatedHospitals();
            renderPagination();
        }

        function haversineMiles(lat1, lon1, lat2, lon2) {
            const R = 3959; // miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Cards + pagination (UI classes preserved)
        function displayHospitals(hospitals) {
            const hospitalList = document.getElementById('healthCenters');
            if (!hospitalList) return;
            hospitalList.innerHTML = '';

            if (!Array.isArray(hospitals)) return;

            hospitals.forEach(hospital => {
                const distance = (typeof hospital.distance === 'number')
                    ? `${hospital.distance.toFixed(1)} miles`
                    : 'N/A';
                const hospitalName = hospital.name || 'Unknown Hospital';
                const address = hospital.address || 'Address not available';
                const phoneNumber = hospital.phone || 'Phone not available';
                const openingHours = typeof hospital.openingHours === 'string'
                    ? hospital.openingHours
                    : (Array.isArray(hospital.openingHours) ? hospital.openingHours[0] : 'Hours not available');
                const types = (Array.isArray(hospital.types) ? hospital.types : ['hospital']).join(', ');

                const card = `
<div class="health-center-card collapsed" style="position: relative;">
  <button type="button" class="btn-close"
    style="position:absolute; right:15px; top:15px; z-index:2; filter: invert(1);"
    onclick="event.stopPropagation(); collapseCard(this.closest('.health-center-card'))"></button>

  <div class="d-flex justify-content-between align-items-start mb-2">
    <h5 class="mb-0 w-75 hospital-name">${hospitalName}</h5>
    <div class="text-end small-distance">
      <small class="text-black"><i class="fas fa-route me-1"></i>${distance}</small>
    </div>
  </div>

  <div class="mb-3 tags-container">
    ${types
                        .split(', ')
                        .filter(type => type !== "point_of_interest")
                        .map(type => `<span class="service-tag">${type.charAt(0).toUpperCase() + type.slice(1)}</span>`)
                        .join(' ')}
  </div>

  <div class="mt-3 d-flex justify-content-between align-items-center like-container">
    <div class="action-like2 d-flex gap-1" style="cursor: pointer;">
      <img src="assets/icons/like.svg" alt="Rating" class="me-2" style="width:22px; height:22px; filter: invert(1);">
      <h6>0</h6>
    </div>
    <div class="action-like2 d-flex gap-1" style="cursor: pointer;">
      <img src="assets/icons/dislike.svg" alt="Rating" class="me-2" style="width:22px; height:22px; filter: invert(1);">
      <h6>0</h6>
    </div>
    <div>
      <button onclick="toggleExpand(this.closest('.health-center-card'))" class="view-details-btn">View Details</button>
    </div>
  </div>

  <div class="extra-details d-none">
    <div class="mb-2">
      <i class="fas fa-map-marker-alt me-2"></i>
      <strong>Address:</strong> ${address}
    </div>
    <div class="mb-2">
      <i class="fas fa-phone me-2"></i>
      <strong>Tel:</strong> ${phoneNumber}
    </div>
    <div class="mb-2">
      <i class="fas fa-clock me-2"></i>
      <strong>Opening Hours:</strong> ${typeof openingHours === 'string' ? openingHours.replace(/:/, ': ') : openingHours}
    </div>

    <div class="d-flex justify-content-between w-100 align-content-center">
      <div>
        <i class="fas fa-route me-2"></i>
        <strong>Distance:</strong> ${distance}
      </div>
      <button class="report-btn d-none" onclick="event.stopPropagation(); openReportModal('${hospitalName.replace(/'/g, "\\'")}')">Report</button>
    </div>
    <div class="mt-3 d-flex justify-content-between align-items-center like-container">
      <div class="action-like d-flex gap-1" data-action="like" style="cursor: pointer;">
        <img src="assets/icons/like.svg" alt="Rating" class="me-2" style="width:22px; height:22px;">
        <h6>0</h6>
      </div>
          <a class="btn directions-btn" href="https://www.google.com/maps?q=${hospital.lat},${hospital.lon}" target="_blank" rel="noopener noreferrer">Directions</a>
        
      <div class="action-like d-flex gap-1" data-action="dislike" style="cursor: pointer;">
        <img src="assets/icons/dislike.svg" alt="Rating" class="me-2" style="width:22px; height:22px;">
        <h6>0</h6>
      </div>
    </div>
  </div>
</div>
`;
                hospitalList.innerHTML += card;
            });
        }

        function displayPaginatedHospitals() {
            const totalItems = filteredHospitals.length;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageItems = filteredHospitals.slice(startIndex, endIndex);

            displayHospitals(pageItems);
            addHospitalMarkers(pageItems);
        }

        // Marker helpers (Leaflet)
        function addHospitalMarkers(hospitals) {
            // Clear existing
            hospitalMarkers.forEach(m => map.removeLayer(m));
            hospitalMarkers = [];

            if (!Array.isArray(hospitals)) return;

            const hospitalIcon = L.divIcon({
                html: '<div style="color:white;background:#EA4335;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;">H</div>',
                className: "",
                iconSize: [24, 24],
                popupAnchor: [0, -10]
            });

            hospitals.forEach(h => {
                if (typeof h.lat !== 'number' || typeof h.lon !== 'number') return;

                const marker = L.marker([h.lat, h.lon], { icon: hospitalIcon, title: h.name || 'Hospital' }).addTo(map);
                marker.bindPopup(`
          <div style="max-width: 350px; padding: 0 10px;" class="map-details-popup">
            <div style="margin-bottom: 10px;">
              <h6 style="margin: 0; color: #368186; font-weight: bold;">${h.name || 'Hospital'}</h6>
            </div>
            <div style="margin-bottom: 8px;" class="mt-2">
              <i class="fas fa-map-marker-alt mx-2" style="color: #368186; font-size: 15px;"></i>
              <span style="font-size: 17px;">${h.address || 'Address not available'}</span>
            </div>
          </div>
        `);

                marker.on('click', () => {
                    toggleCardFromMarker(h.name || 'Hospital');
                });

                hospitalMarkers.push(marker);
            });
        }

        function toggleCardFromMarker(hospitalName) {
            const cards = document.querySelectorAll('.health-center-card');
            cards.forEach(card => {
                const title = card.querySelector('h5, h4');
                if (title && title.innerText === hospitalName) {
                    toggleExpand(card);
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }

        function highlightMarker(hospitalName, highlight) {
            // Optional: could swap icon or style; Leaflet DivIcon element is internal — skip heavy styling changes to keep it robust
            // This function kept for API-compat; no-op visual tweak
        }

        function showMarkerPopup(hospitalName) {
            const marker = hospitalMarkers.find(m => (m.options?.title || '') === hospitalName);
            if (marker) {
                marker.openPopup();
            }
        }

        // Expand/Collapse cards (UI behavior preserved)
        function collapseCard(card) {
            if (!card) return;
            const details = card.querySelector(".extra-details");
            const reportBtn = card.querySelector(".report-btn");
            const distance = card.querySelector(".small-distance");
            const titleEl = card.querySelector("h5, h4");
            if (details) details.classList.add("d-none");
            if (reportBtn) reportBtn.classList.add("d-none");
            if (distance) distance.classList.remove("d-none");

            if (titleEl && titleEl.tagName.toLowerCase() === "h4") {
                const name = titleEl.innerText;
                titleEl.outerHTML = `<h5 class="mb-0">${name}</h5>`;
                highlightMarker(name, false);
            }
            card.classList.remove("expanded");
        }

        function toggleExpand(card) {
            if (!card) return;

            document.querySelectorAll(".health-center-card.expanded").forEach(c => {
                if (c !== card) collapseCard(c);
            });

            if (card.classList.contains("expanded")) return;

            card.classList.add("expanded");

            const details = card.querySelector(".extra-details");
            const reportBtn = card.querySelector(".report-btn");
            const distance = card.querySelector(".small-distance");
            const title = card.querySelector("h5, h4");

            if (details) details.classList.remove("d-none");
            if (reportBtn) reportBtn.classList.remove("d-none");
            if (distance) distance.classList.add("d-none");

            if (title && title.tagName.toLowerCase() === "h5") {
                title.outerHTML = `<h4 class="mb-0">${title.innerText}</h4>`;
            }

            const hospitalName = title ? title.innerText : "";
            highlightMarker(hospitalName, true);
            showMarkerPopup(hospitalName);
        }

        // Like/dislike counters (unchanged behavior)
        document.addEventListener('click', function (e) {
            const actionEl = e.target.closest('.action-like');
            if (!actionEl) return;
            e.stopPropagation();
            const countEl = actionEl.querySelector('h6');
            if (!countEl) return;
            const current = parseInt(countEl.textContent || '0', 10) || 0;
            countEl.textContent = current + 1;
        });

        // Pagination (UI preserved)
        function renderPagination() {
            const paginationDiv = document.getElementById('pagination');
            if (!paginationDiv) return;

            const totalItems = filteredHospitals.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            if (totalItems === 0) {
                paginationDiv.innerHTML = '';
                return;
            }

            const startItem = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            paginationDiv.innerHTML = `
    <div class="d-flex flex-column mt-4 flex-md-row justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center w-100 justify-content-between justify-content-lg-center" style="gap: 20px;">
        <button type="button" class="btn btn-outline-secondary btn-sm"
          onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="mx-3">${startItem}-${endItem} of ${totalItems}</span>
        <button type="button" class="btn btn-outline-secondary btn-sm"
          onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
    `;
        }

        function changePage(newPage) {
            const totalPages = Math.ceil(filteredHospitals.length / itemsPerPage);
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayPaginatedHospitals();
                renderPagination();
            }
        }

        // Mobile menu and search popup (unchanged behavior)
        function commingSoon(text) {
            profileModal.classList.add('show');
            document.getElementById('overlay2').classList.add('show');
            document.querySelector('#profileModal p').innerHTML = `<p>${text} isn’t available yet!</p>`;
        }

        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        menuToggle.addEventListener('click', function () {
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        });
        overlay.addEventListener('click', function () {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            const locModal = document.getElementById('locationModal');
            if (locModal) locModal.classList.remove('show');
        });

        const searchSection = document.getElementById('searchSection');
        if (searchSection) {
            searchSection.addEventListener('click', function () {
                const searchPopup = document.getElementById('seach-popup');
                if (searchPopup) searchPopup.classList.remove('d-none');
            });
        }

        const closeBtn = document.querySelector('#seach-popup .btn-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', function () {
                const searchPopup = document.getElementById('seach-popup');
                if (searchPopup) searchPopup.classList.add('d-none');
            });
        }

        // Search submit -> Geoapify geocoding + load hospitals
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                try {
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('error').style.display = 'none';

                    const country = document.getElementById('user-country')?.value || '';
                    const state = document.getElementById('user-state')?.value || '';
                    const city = document.getElementById('city')?.value || '';
                    const service = document.getElementById('services-type')?.value || '';

                    if (!country) {
                        alert("Country is required");
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }

                    let query = '';
                    if (city) query = `${city}, ${state}, ${country}`;
                    else if (state) query = `${state}, ${country}`;
                    else query = country;

                    const geo = await geoapifyGeocode(query);
                    if (!geo) {
                        document.getElementById('loading').style.display = 'none';
                        alert('Location not found. Please try a different search.');
                        return;
                    }

                    if (userMarker) map.removeLayer(userMarker);
                    userMarker = L.marker([geo.lat, geo.lon]).addTo(map).bindPopup('<b>Your selected location</b>').openPopup();

                    if (userCircle) { map.removeLayer(userCircle); }
                    userCircle = L.circle([geo.lat, geo.lon], {
                        color: "#d90429",
                        fillColor: "#ef233c",
                        fillOpacity: 0.2,
                        radius: SEARCH_RADIUS_METERS
                    }).addTo(map);

                    // Zoom adjustments by specificity
                    let zoomLevel = 10;
                    if (city) zoomLevel = 13;
                    else if (state) zoomLevel = 8;
                    else zoomLevel = 6;

                    map.setView([geo.lat, geo.lon], zoomLevel);

                    navigator.geolocation.getCurrentPosition(async position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // Fetch address from coordinates
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                        const data = await response.json();

                        navigator.geolocation.getCurrentPosition(async position => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;

                            try {
                                const response = await fetch(
                                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`,
                                    { headers: { 'User-Agent': 'location-app' } }
                                );
                                const data = await response.json();

                                const address = data.address;
                                let shortAddress = '';

                                if (address.city) shortAddress += address.city;
                                else if (address.town) shortAddress += address.town;
                                else if (address.village) shortAddress += address.village;

                                if (address.state) shortAddress += `, ${address.state}`;
                                if (address.country) shortAddress += `, ${address.country}`;

                                const userLocationEl = document.getElementById('user-location');
                                if (userLocationEl) {
                                    userLocationEl.innerText = `Your Selected Location: ${shortAddress || data.display_name}`;
                                }
                            } catch (error) {
                                console.error(error);
                                const userLocationEl = document.getElementById('user-location');
                                if (userLocationEl) {
                                    userLocationEl.innerText = 'Unable to fetch address.';
                                }
                            }
                        }, () => {
                            const userLocationEl = document.getElementById('user-location');
                            if (userLocationEl) {
                                userLocationEl.innerText = 'Location access denied.';
                            }
                        });

                    });


                    const searchPopup = document.getElementById('seach-popup');
                    if (searchPopup) searchPopup.classList.add('d-none');

                    userLocation = { lat: geo.lat, lon: geo.lon };
                    await loadNearbyHospitals(geo.lat, geo.lon, service);
                    document.getElementById('loading').style.display = 'none';
                } catch {
                    document.getElementById('loading').style.display = 'none';
                    alert('Error processing search. Please try again.');
                }
            });
        }

        window.addEventListener("beforeunload", () => {
            localStorage.removeItem("searchData");
        });

        // Boot: get user location, then load map + hospitals
        getCurrentUserLocation();
    </script>
</body>

</html>