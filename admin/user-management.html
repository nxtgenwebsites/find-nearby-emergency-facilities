<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Health Centre App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css"
        integrity="sha512-3pIirOrwegjM6erE5gPSwkUzO+3cTjpnV9lexlNZqvupR64iZBnOOTiiLPb9M36zpMScbmUNIcHUqKD47M719g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/user-management.css" />
    <link rel="stylesheet" href="css/responsive.css" />
    <link rel="shortcut icon" href="assets/images/favicon.png" type="image/x-icon">
</head>

<body>
    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>
    <div class="overlay" id="overlay2"></div>
    <!-- Delete Confirmation Popup -->
    <div id="deleteUserPopup" class="popup-overlay">
        <div class="popup-card">
            <h3>Delete User?</h3>
            <p>Are you sure you want to delete this user? This action cannot be undone.</p>
            <div class="popup-buttons">
                <button class="cancel-btn" id="cancelDelete">Cancel</button>
                <button class="delete-btn" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Block/Unblock Popup -->
    <div id="blockUserPopup" class="popup-overlay">
        <div class="popup-card">
            <h3 id="blockTitle">Block User?</h3>
            <p id="blockMessage">Are you sure you want to block this user?</p>
            <div class="popup-buttons">
                <button id="cancelBlock" class="cancel-btn">Cancel</button>
                <button id="confirmBlock" class="confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Profile placeholder modal -->
    <div class="location-modal" id="profileModal">
        <h3>Coming Soon!</h3>
        <p>User profile feature isn't available yet!</p>
        <div class="location-buttons">
            <button class="btn-location btn-allow" id="closeProfileBtn">Go back</button>
        </div>
    </div>

    <!-- Toaster -->
    <div id="toaster" class="toaster" aria-live="polite" aria-atomic="true"></div>

    <div class="d-flex w-100">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo">
                    <div class="logo-img">
                        <img src="assets/images/logo.svg" alt="Health Centre App logo" />
                    </div>
                </a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fa-solid fa-house"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="user-management.html" class="nav-link active">
                        <i class="fa-solid fa-users"></i>
                        <span>User Management</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="review-management.html" class="nav-link">
                        <i class="fa-solid fa-star"></i>
                        <span>Reviews</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="ads-management.html" class="nav-link">
                        <i class="fa-solid fa-handshake"></i>
                        <span>Ads Management</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Add User Modal -->
        <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius:.9rem;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addUserLabel">Add User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <form id="addUserForm">
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Title</label>
                                    <select class="form-select" name="title" required>
                                        <option value="">Select</option>
                                        <option value="Mr">Mr</option>
                                        <option value="Mrs">Mrs</option>
                                        <option value="Miss">Miss</option>
                                        <option value="Ms">Ms</option>
                                        <option value="Prof">Prof</option>
                                        <option value="Rev">Rev</option>
                                        <option value="Alhj">Alhj</option>
                                        <option value="Mlm">Mlm</option>
                                        <option value="Hon">Hon</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" name="firstName" required />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" name="lastName" required />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Gender</label>
                                    <select class="form-select" name="gender" required>
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" required />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Country</label>
                                    <input type="text" class="form-control" name="country" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" name="password" required />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" name="confirm_password" required />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Role</label>
                                    <select class="form-select" name="role">
                                        <option value="user">User</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline-gray" data-bs-dismiss="modal" type="button">Cancel</button>
                            <button class="btn btn-teal" type="submit">Save User</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius:.9rem;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editUserLabel">Edit User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <form id="editUserForm">
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Title</label>
                                    <select class="form-select" name="title" required>
                                        <option value="">Select</option>
                                        <option value="Mr">Mr</option>
                                        <option value="Mrs">Mrs</option>
                                        <option value="Miss">Miss</option>
                                        <option value="Ms">Ms</option>
                                        <option value="Prof">Prof</option>
                                        <option value="Rev">Rev</option>
                                        <option value="Alhj">Alhj</option>
                                        <option value="Mlm">Mlm</option>
                                        <option value="Hon">Hon</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" name="firstName" required />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" name="lastName" required />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Gender</label>
                                    <select class="form-select" name="gender">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" required />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Country</label>
                                    <input type="text" class="form-control" name="country" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Role</label>
                                    <select class="form-select" name="role">
                                        <option value="user">User</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">New Password (optional)</label>
                                    <input type="password" class="form-control" name="password" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" name="confirm_password" />
                                </div>
                                <input type="hidden" name="id" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline-gray" data-bs-dismiss="modal" type="button">Cancel</button>
                            <button class="btn btn-teal" type="submit">Save Changes</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>

        <!-- View User Modal -->
        <div class="modal fade" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content" style="border-radius:.9rem;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewUserLabel">User Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3 py-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label small-muted">Full Name</label>
                                <div class="fw-semibold" id="vuName">-</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small-muted">Email</label>
                                <div class="fw-semibold" id="vuEmail">-</div>
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label small-muted">Title</label>
                                <div class="fw-semibold" id="vuTitle">-</div>
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label small-muted">Gender</label>
                                <div class="fw-semibold" id="vuGender">-</div>
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label small-muted">Country</label>
                                <div class="fw-semibold" id="vuCountry">-</div>
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label small-muted">Role</label>
                                <div id="vuRole"><span class="badge-pill role-user">user</span></div>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small-muted">Status</label>
                                <div id="vuStatus"><span class="badge-pill status-active">active</span></div>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small-muted">Created</label>
                                <div id="vuCreated">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content w-100">
            <!-- Header -->
            <header class="header d-lg-none">
                <a href="/" class="mobile-logo">
                    <img src="assets/images/logo.svg" alt="Health Centre App logo" />
                </a>
                <div class="header-right">
                    <div class="dropdown user profile-button">
                        <button class="mobile-profile-btn dropdown-toggle" type="button" id="mobileProfileMenu"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="assets/icons/user-icon.svg" alt="User">
                        </button>

                        <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="mobileProfileMenu">
                            <li><a class="dropdown-item" href="/user/profile.html">Profile</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><button class="dropdown-item text-danger" id="logout-btn">Logout</button></li>
                        </ul>
                    </div>

                    <button class="menu-toggle" id="menuToggle">
                        <img src="assets/icons/bars.svg" alt="">
                    </button>
                </div>
            </header>

            <div class="main-content w-100">
                <!-- Profile Button -->
                <div class="dropdown profile-wrapper">
                    <button
                        class="profile-btn d-none d-lg-flex align-items-center justify-content-center dropdown-toggle"
                        type="button" id="profileMenuButton" data-bs-toggle="dropdown" aria-expanded="false"
                        style="gap: 5px !important;">
                        <img src="assets/icons/user-icon.svg" width="30" alt="">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="profileMenuButton">
                        <li><a class="dropdown-item" href="/user/profile.html">Profile</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><button class="dropdown-item text-danger" id="logout-btn">Logout</button></li>
                    </ul>
                </div>

                <div class="hero-content">
                    <div class="container-fluid um-section">

                        <!-- Header + CTAs -->
                        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                            <div>
                                <h2 class="mb-1" style="color:var(--dark-gray)">User Management</h2>
                                <p class="mb-0 small-muted">Manage users, roles, and permissions</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-teal" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                    <i class="fa-solid fa-user-plus me-2"></i>Add User
                                </button>
                            </div>
                        </div>

                        <!-- Metric Cards -->
                        <div class="row g-3 mb-3">
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="um-card stat-card" id="statCardTotal" style="cursor: pointer;">
                                    <div class="stat-icon" style="background:var(--secondary-blue)">
                                        <i class="fa-solid fa-users"></i>
                                    </div>
                                    <div>
                                        <div class="small-muted">Total Users</div>
                                        <div class="stat-value" id="statTotalUsers">0</div>
                                        <div class="stat-delta up">+12% vs last month</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="um-card stat-card" id="statCardActive" style="cursor: pointer;">
                                    <div class="stat-icon">
                                        <i class="fa-solid fa-user-check"></i>
                                    </div>
                                    <div>
                                        <div class="small-muted">Active Users</div>
                                        <div class="stat-value" id="statActiveUsers">0</div>
                                        <div class="stat-delta up">+8% vs last week</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="um-card stat-card" id="statCardMonth" style="cursor: pointer;">
                                    <div class="stat-icon bg-soft-blue" style="color:#1f4d7a;">
                                        <img src="https://cdn-icons-png.flaticon.com/512/1442/1442930.png"
                                            style="width: 20px;" alt="">
                                    </div>
                                    <div>
                                        <div class="small-muted">New This Month</div>
                                        <div class="stat-value" id="statNew">0</div>
                                        <div class="stat-delta up">+15% growth</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Management Table -->
                        <div class="um-card">
                            <div class="um-card-header">
                                <input type="search" id="searchUser" class="form-control" placeholder="Search user"
                                    aria-label="Search by name or email" />
                                <div class="filter-wrap d-flex gap-2">
                                    <select id="filterStatus" class="form-select" aria-label="Filter by status">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="blocked">Blocked</option>
                                    </select>
                                    <select id="filterRole" class="form-select" aria-label="Filter by role">
                                        <option value="">All Roles</option>
                                        <option value="admin">Admin</option>
                                        <option value="user">User</option>
                                    </select>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table align-middle mb-0" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th scope="col">Name</th>
                                            <th scope="col">Email</th>
                                            <th scope="col">Role</th>
                                            <th scope="col">Status</th>
                                            <th scope="col" class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody"></tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-between align-items-center p-3">
                                <div class="small-muted" id="paginationText">Showing 0 to 0 of 0 results</div>
                                <nav aria-label="pagination">
                                    <ul class="pagination mb-0" id="paginationContainer">
                                        <li class="page-item" id="prevBtn"><button class="page-link">Previous</button>
                                        </li>
                                        <li class="page-item" id="pageNumbers"></li>
                                        <li class="page-item" id="nextBtn"><button class="page-link">Next</button></li>
                                    </ul>
                                </nav>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Footer -->
                <footer class="footer dashboard-footer">
                    <div class="container">
                        <div class="footer-content">
                            <div class="footer-text">Â© 2025 HealthCentreApp.com- All Rights Reserved.</div>
                            <div class="footer-links">
                                <a href="privacy-policy.html">Privacy Policy</a>
                                <span>|</span>
                                <a href="terms-and-conditions.html">Terms & Conditions</a>
                                <a href="https://facebook.com/healthcentreapp/" target="_blank" class="social"
                                    style="cursor: pointer;">
                                    <img src="assets/icons/facebook 1.svg" alt="Facebook" />
                                </a>
                            </div>
                        </div>
                    </div>
                </footer>

            </div>
        </div>
    </div>

    <script src="js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>

        function showToast(type = 'info', message = '') {
            const container = document.getElementById('toaster');
            if (!container) { try { alert(message); } catch (_) { } return; }
            const el = document.createElement('div');
            el.className = `toast ${type} toast-enter`;
            const title = type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Notice';
            el.innerHTML = `
        <div>
          <div class="title">${title}</div>
          <div class="msg">${message}</div>
        </div>
        <button class="close" aria-label="Close toast">&times;</button>
      `;
            const close = () => {
                el.classList.remove('toast-enter');
                el.classList.add('toast-exit');
                setTimeout(() => el.remove(), 180);
            };
            el.querySelector('.close').addEventListener('click', close);
            container.appendChild(el);
            setTimeout(close, 3200);
        }
    </script>

    <script>
        // API config
        const uId = localStorage.getItem('uid');
        if (!uId) {
            window.location.href = '/login.html';
        }

        // Handle all profile buttons (desktop + mobile)
        const allProfiles = document.querySelectorAll(".profile-wrapper, .profile-button");

        allProfiles.forEach(wrapper => {
            const button = wrapper.querySelector("button, .profile-btn, .mobile-profile-btn");
            const dropdownMenu = wrapper.querySelector(".dropdown-menu");

            if (!button) return;

            if (!uId) {
                button.classList.remove("dropdown-toggle");
                if (dropdownMenu) dropdownMenu.style.display = "none";
                button.innerHTML = `
    <img src="assets/icons/user-icon.svg" width="28" alt="">
    <span class="mx-2">Sign In</span>
    `;
                button.onclick = () => (window.location.href = "/login.html");
                button.removeAttribute("data-bs-toggle");
            } else {
                button.classList.add("dropdown-toggle");
                button.innerHTML = `
    <img src="assets/icons/user-icon.svg" width="28" alt="">
    <span class="me-1" style="margin-right: -5px !important;">My Account</span>
    <i class="bi bi-chevron-down ms-1"></i>
`;
                button.setAttribute("data-bs-toggle", "dropdown");
            }
        });

        // Logout logic
        document.addEventListener("click", e => {
            if (e.target.id === "logout-btn") {
                localStorage.removeItem("uid");
                location.reload();
            }
        });

        const api = axios.create({
            baseURL: 'https://find-nearby-emergency-facilities-ba.vercel.app/api/users',
            timeout: 10000,
            headers: { 'Content-Type': 'application/json' },
        });

        let usersCache = [];
        api.interceptors.response.use(
            (res) => res,
            (error) => {
                const msg = error?.response?.data?.message || error?.message || 'Request failed';
                showToast('error', msg);
                return Promise.reject(error);
            }
        );

        let currentPage = 1;
        const itemsPerPage = 8;

        async function getData() {
            try {
                const res = await api.get(`/get-users/${uId}`);
                const users = res.data?.data || [];
                usersCache = users;

                const tableBody = document.getElementById('userTableBody');
                tableBody.innerHTML = '';

                users.forEach((user) => {
                    const row = `
            <tr data-id="${user._id || ''}">
              <td><strong>${user.firstName || 'N/A'} ${user.lastName || ''}</strong></td>
              <td>${user.email || '-'}</td>
              <td>
                <span class="badge-pill ${user.role === 'admin' ? 'role-admin' : 'role-user'}">
                  ${user.role || 'user'}
                </span>
              </td>
              <td>
                <span class="badge-pill ${user.isBlocked ? 'status-blocked' : 'status-active'}">
                  ${user.isBlocked ? 'blocked' : 'active'}
                </span>
              </td>
              <td class="text-end action-buttons">
                <button class="btn-action view" title="View" onclick="viewUser('${user._id}')">
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button class="btn-action update" title="Update" onclick="updateUser('${user._id}')">
                  <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <button class="btn-action block" title="${user.isBlocked ? 'Unblock' : 'Block'}" onclick="toggleBlockUser('${user._id}', ${user.isBlocked})">
                  <i class="fa-solid fa-ban"></i>
                </button>
                <button class="btn-action delete" title="Delete" onclick="deleteUser('${user._id}')">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });

                const total = users.length;
                const active = users.filter(u => !u.isBlocked).length;
                const now = new Date();
                const m = now.getMonth(), y = now.getFullYear();
                const newThisMonth = users.filter(u => {
                    if (!u.createdAt) return false;
                    const d = new Date(u.createdAt);
                    return d.getFullYear() === y && d.getMonth() === m;
                }).length;

                const totalEl = document.getElementById('statTotalUsers');
                const activeEl = document.getElementById('statActiveUsers');
                const newEl = document.getElementById('statNew');

                if (totalEl) totalEl.textContent = total;
                if (activeEl) activeEl.textContent = active;
                if (newEl) newEl.textContent = newThisMonth;

                currentPage = 1;
                applyFilters();
            } catch (error) {
                console.error('Error fetching users:', error);
                showToast('error', error?.response?.data?.message || 'Error fetching users');
            }
        }

        document.getElementById("addUserForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const form = e.target;
            const firstName = form.querySelector('[name="firstName"]').value.trim();
            const lastName = form.querySelector('[name="lastName"]').value.trim();
            const email = form.querySelector('[name="email"]').value.trim();
            const password = form.querySelector('[name="password"]').value.trim();
            const confirm_password = form.querySelector('[name="confirm_password"]').value.trim();
            const role = form.querySelector('[name="role"]').value;
            const title = form.querySelector('[name="title"]').value;
            const gender = form.querySelector('[name="gender"]').value;
            const country = form.querySelector('[name="country"]').value;

            if (password !== confirm_password) {
                showToast("error", "Passwords do not match");
                return;
            }

            try {
                const payload = {
                    firstName,
                    lastName,
                    email,
                    password,
                    role,
                    title,
                    gender,
                    country,
                };

                const response = await axios.post(`https://find-nearby-emergency-facilities-ba.vercel.app/api/users/add/${uId}`, payload);

                if (response.data.success) {
                    showToast("success", "User added successfully");
                    form.reset();
                    getData();
                    const modal = bootstrap.Modal.getInstance(document.getElementById("addUserModal"));
                    if (modal) modal.hide();
                } else {
                    showToast("error", response.data.message || "Failed to add user");
                }
            } catch (error) {
                console.error(error);
                showToast("error", error.response?.data?.message || "Internal server error");
            }
        });

        let deleteUserId = null;

        function deleteUser(id) {
            deleteUserId = id;
            document.getElementById('deleteUserPopup').style.display = 'flex';
        }

        document.getElementById('confirmDelete').addEventListener('click', async () => {
            if (!deleteUserId) return;
            try {
                await api.delete(`/delete/${uId}`, { data: { id: deleteUserId } });
                showToast('success', 'User deleted successfully');
                getData();
            } catch (error) {
                console.error(error);
                showToast('error', 'Failed to delete user');
            }
            closeDeletePopup();
        });

        document.getElementById('cancelDelete').addEventListener('click', closeDeletePopup);

        function closeDeletePopup() {
            document.getElementById('deleteUserPopup').style.display = 'none';
        }

        // Block / Unblock User
        let blockUserId = null;
        let blockAction = null;

        function toggleBlockUser(userId, isBlocked) {
            blockUserId = userId;
            blockAction = isBlocked ? 'unblock' : 'block';

            const title = document.getElementById('blockTitle');
            const message = document.getElementById('blockMessage');
            const confirmBtn = document.getElementById('confirmBlock');

            if (isBlocked) {
                title.textContent = 'Unblock User?';
                message.textContent = 'Are you sure you want to unblock this user?';
                confirmBtn.textContent = 'Unblock';
                confirmBtn.classList.add('unblock');
            } else {
                title.textContent = 'Block User?';
                message.textContent = 'Are you sure you want to block this user?';
                confirmBtn.textContent = 'Block';
                confirmBtn.classList.remove('unblock');
            }

            document.getElementById('blockUserPopup').style.display = 'flex';
        }

        document.getElementById('confirmBlock').addEventListener('click', async () => {
            if (!blockUserId || !blockAction) return;

            const url = blockAction === 'block' ? `/block/${uId}` : `/unblock/${uId}`;

            try {
                const res = await api.put(url, { id: blockUserId });
                showToast('success', res?.data?.message || `User ${blockAction}ed successfully`);
                getData();
            } catch (error) {
                console.error(error);
                showToast('error', `Failed to ${blockAction} user`);
            }

            closeBlockPopup();
        });

        document.getElementById('cancelBlock').addEventListener('click', closeBlockPopup);

        function closeBlockPopup() {
            document.getElementById('blockUserPopup').style.display = 'none';
        }

        // View User
        function viewUser(id) {
            const u = usersCache.find(x => String(x._id) === String(id));
            if (!u) { showToast('error', 'User not found'); return; }

            const fullName = [u.firstName, u.lastName].filter(Boolean).join(' ').trim() || 'N/A';
            const email = u.email || '-';
            const role = u.role || 'user';
            const isBlocked = !!u.isBlocked;
            const created = u.createdAt ? new Date(u.createdAt) : null;

            document.getElementById('vuName').textContent = fullName;
            document.getElementById('vuEmail').textContent = email;
            document.getElementById('vuTitle').textContent = u.title || '-';
            document.getElementById('vuGender').textContent = u.gender || '-';
            document.getElementById('vuCountry').textContent = u.country || '-';

            const roleEl = document.getElementById('vuRole');
            roleEl.innerHTML = `<span class="badge-pill ${role === 'admin' ? 'role-admin' : 'role-user'}">${role}</span>`;

            const statusEl = document.getElementById('vuStatus');
            statusEl.innerHTML = `<span class="badge-pill ${isBlocked ? 'status-blocked' : 'status-active'}">${isBlocked ? 'blocked' : 'active'}</span>`;

            document.getElementById('vuCreated').textContent = created ? created.toLocaleString() : '-';

            const modalEl = document.getElementById('viewUserModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.show();
        }

        function updateUser(id) {
            const u = usersCache.find(x => String(x._id) === String(id));
            if (!u) {
                showToast('error', 'User not found');
                return;
            }

            const form = document.getElementById('editUserForm');
            form.elements['id'].value = u._id || '';
            form.elements['firstName'].value = u.firstName || '';
            form.elements['lastName'].value = u.lastName || '';
            form.elements['email'].value = u.email || '';
            form.elements['title'].value = u.title || '';
            form.elements['gender'].value = u.gender || '';
            form.elements['country'].value = u.country || '';
            form.elements['role'].value = u.role === 'admin' ? 'admin' : 'user';
            form.elements['password'].value = '';
            form.elements['confirm_password'].value = '';

            const modalEl = document.getElementById('editUserModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.show();
        }

        document.getElementById("editUserForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const form = e.target;

            const userId = form.elements["id"].value.trim();
            const firstName = form.elements["firstName"].value.trim();
            const lastName = form.elements["lastName"].value.trim();
            const email = form.elements["email"].value.trim();
            const role = form.elements["role"].value.trim();
            const password = form.elements["password"].value.trim();
            const confirm_password = form.elements["confirm_password"].value.trim();
            const title = form.elements["title"].value;
            const gender = form.elements["gender"].value;
            const country = form.elements["country"].value;

            if (password && password !== confirm_password) {
                showToast("error", "Passwords do not match");
                return;
            }

            try {
                const response = await axios.put(
                    `https://find-nearby-emergency-facilities-ba.vercel.app/api/users/edit/${uId}/${userId}`,
                    { firstName, lastName, email, password, role, title, gender, country }
                );

                if (response.data.success) {
                    showToast("success", "User updated successfully");
                    const modalEl = document.getElementById("editUserModal");
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    getData();
                } else {
                    showToast("error", response.data.message || "Failed to update user");
                }
            } catch (err) {
                console.error(err);
                showToast("error", err.response?.data?.message || "Internal server error");
            }
        });

        getData();
    </script>

    <script>
        // Filter and pagination system
        const searchUser = document.getElementById('searchUser');
        const filterStatus = document.getElementById('filterStatus');
        const filterRole = document.getElementById('filterRole');

        function getFilteredUsers() {
            const q = (searchUser?.value || '').trim().toLowerCase();
            const st = (filterStatus?.value || '').toLowerCase();
            const rl = (filterRole?.value || '').toLowerCase();

            return usersCache.filter(user => {
                const name = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                const email = (user.email || '').toLowerCase();
                const role = (user.role || 'user').toLowerCase();
                const status = user.isBlocked ? 'blocked' : 'active';

                const okQ = q === '' || name.includes(q) || email.includes(q);
                const okS = st === '' || status === st;
                const okR = rl === '' || role === rl;

                return okQ && okS && okR;
            });
        }

        function renderPagination(filteredUsers) {
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
            const pageNumbersContainer = document.getElementById('pageNumbers');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            pageNumbersContainer.innerHTML = '';

            if (currentPage > totalPages) currentPage = Math.max(1, totalPages);

            if (currentPage === 1) {
                prevBtn.classList.add('disabled');
                prevBtn.querySelector('button').disabled = true;
            } else {
                prevBtn.classList.remove('disabled');
                prevBtn.querySelector('button').disabled = false;
                prevBtn.querySelector('button').onclick = () => {
                    currentPage--;
                    applyFilters();
                };
            }

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const btn = document.createElement('button');
                btn.className = 'page-link';
                btn.textContent = i;
                btn.onclick = () => {
                    currentPage = i;
                    applyFilters();
                };
                li.appendChild(btn);
                pageNumbersContainer.appendChild(li);
            }

            if (currentPage === totalPages || totalPages === 0) {
                nextBtn.classList.add('disabled');
                nextBtn.querySelector('button').disabled = true;
            } else {
                nextBtn.classList.remove('disabled');
                nextBtn.querySelector('button').disabled = false;
                nextBtn.querySelector('button').onclick = () => {
                    currentPage++;
                    applyFilters();
                };
            }
        }

        function updatePaginationText(filteredUsers) {
            const total = filteredUsers.length;
            const start = total === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, total);
            document.getElementById('paginationText').textContent = `Showing ${start} to ${end} of ${total} results`;
        }

        function applyFilters() {
            const filteredUsers = getFilteredUsers();
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);

            if (currentPage > totalPages) currentPage = Math.max(1, totalPages);

            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const paginatedUsers = filteredUsers.slice(startIdx, endIdx);

            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';

            if (paginatedUsers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No users found</td></tr>';
            } else {
                paginatedUsers.forEach((user) => {
                    const row = `
                <tr data-id="${user._id || ''}">
                  <td><strong>${user.firstName || 'N/A'} ${user.lastName || ''}</strong></td>
                  <td>${user.email || '-'}</td>
                  <td>
                    <span class="badge-pill ${user.role === 'admin' ? 'role-admin' : 'role-user'}">
                      ${user.role || 'user'}
                    </span>
                  </td>
                  <td>
                    <span class="badge-pill ${user.isBlocked ? 'status-blocked' : 'status-active'}">
                      ${user.isBlocked ? 'blocked' : 'active'}
                    </span>
                  </td>
                  <td class="text-end action-buttons">
                    <button class="btn-action view" title="View" onclick="viewUser('${user._id}')">
                      <i class="fa-solid fa-eye"></i>
                    </button>
                    <button class="btn-action update" title="Update" onclick="updateUser('${user._id}')">
                      <i class="fa-solid fa-pen-to-square"></i>
                    </button>
                    <button class="btn-action block" title="${user.isBlocked ? 'Unblock' : 'Block'}" onclick="toggleBlockUser('${user._id}', ${user.isBlocked})">
                      <i class="fa-solid fa-ban"></i>
                    </button>
                    <button class="btn-action delete" title="Delete" onclick="deleteUser('${user._id}')">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            renderPagination(filteredUsers);
            updatePaginationText(filteredUsers);
        }

        [searchUser, filterStatus, filterRole].forEach(el => {
            if (el) {
                el.addEventListener('input', () => {
                    currentPage = 1;
                    applyFilters();
                });
                el.addEventListener('change', () => {
                    currentPage = 1;
                    applyFilters();
                });
            }
        });

        document.getElementById('statCardTotal').addEventListener('click', () => {
            searchUser.value = '';
            filterStatus.value = '';
            filterRole.value = '';
            currentPage = 1;
            applyFilters();
        });

        document.getElementById('statCardActive').addEventListener('click', () => {
            searchUser.value = '';
            filterStatus.value = 'active';
            filterRole.value = '';
            currentPage = 1;
            applyFilters();
        });

        document.getElementById('statCardMonth').addEventListener('click', () => {
            searchUser.value = '';
            filterStatus.value = '';
            filterRole.value = '';
            currentPage = 1;

            const now = new Date();
            const m = now.getMonth(), y = now.getFullYear();
            const thisMonthUsers = usersCache.filter(u => {
                if (!u.createdAt) return false;
                const d = new Date(u.createdAt);
                return d.getFullYear() === y && d.getMonth() === m;
            });

            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';

            if (thisMonthUsers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No users found</td></tr>';
            } else {
                const startIdx = 0;
                const endIdx = itemsPerPage;
                const paginatedUsers = thisMonthUsers.slice(startIdx, endIdx);

                paginatedUsers.forEach((user) => {
                    const row = `
                <tr data-id="${user._id || ''}">
                  <td><strong>${user.firstName || 'N/A'} ${user.lastName || ''}</strong></td>
                  <td>${user.email || '-'}</td>
                  <td>
                    <span class="badge-pill ${user.role === 'admin' ? 'role-admin' : 'role-user'}">
                      ${user.role || 'user'}
                    </span>
                  </td>
                  <td>
                    <span class="badge-pill ${user.isBlocked ? 'status-blocked' : 'status-active'}">
                      ${user.isBlocked ? 'blocked' : 'active'}
                    </span>
                  </td>
                  <td class="text-end action-buttons">
                    <button class="btn-action view" title="View" onclick="viewUser('${user._id}')">
                      <i class="fa-solid fa-eye"></i>
                    </button>
                    <button class="btn-action update" title="Update" onclick="updateUser('${user._id}')">
                      <i class="fa-solid fa-pen-to-square"></i>
                    </button>
                    <button class="btn-action block" title="${user.isBlocked ? 'Unblock' : 'Block'}" onclick="toggleBlockUser('${user._id}', ${user.isBlocked})">
                      <i class="fa-solid fa-ban"></i>
                    </button>
                    <button class="btn-action delete" title="Delete" onclick="deleteUser('${user._id}')">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            renderPagination(thisMonthUsers);
            updatePaginationText(thisMonthUsers);
        });
    </script>

    <script>
        const profileButton = document.querySelectorAll('.profile-button');
        const profileModal = document.getElementById('profileModal');
        const closeProfileBtn = document.getElementById('closeProfileBtn');

        closeProfileBtn.addEventListener('click', function () {
            profileModal.classList.remove('show');
            document.getElementById('overlay2').classList.remove('show');
        });

        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        menuToggle.addEventListener('click', function () {
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        });

        overlay.addEventListener('click', function () {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            const loc = document.getElementById('locationModal');
            if (loc) loc.classList.remove('show');
        });

        function handleResize() {
            if (window.innerWidth >= 992) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            }
        }
        window.addEventListener('resize', handleResize);
    </script>

</body>

</html>